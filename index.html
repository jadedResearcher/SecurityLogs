<html>

<head>
  <title>Security Logs</title>
  <link rel="stylesheet" href="index.css">
  <link rel="icon" href="alt.ico" />
  <script src="cctv.js"></script>
  <script src="utils.js"></script>

  <script>
    //https://dev.to/ekeijl/retro-crt-terminal-screen-in-css-js-4afh
    const clickAudio = new Audio("audio/web_SoundFX_254286__jagadamba__mechanical-switch.mp3");
    let speed = 50;

    //consists of a set of terminal log lines, and a cctv feed.
    const cameras = [];

    let current_cctv;
    let typing = false;

    const setupScreens = async() => {
      const button = document.querySelector("#log-button");
      const buttonBar = document.querySelector("#button-bar");

      const canvas = document.querySelector("#canvas");
      const one = await screen1(canvas, buttonBar);
      button.innerHTML = "Click To Log In";

      cameras.push(one);
      const two = await screen2(canvas, buttonBar);
      cameras.push(two);
    }

    const screen1 = async(canvas,buttonBar) => {
      const lines = [
        "[BEGIN LOG: December 14th, 2008]",
        "18:00: DAY SHIFT HERE. BEEN TOLD MOST OF THE PREVIOUS SEC TEAM GOT LET GO. NOT SURE WHY. THEY ONLY JUST GOT THE LOGS AND FEEDS UP AND RUNNING A FEW MINUTES AGO. I WON'T HAVE TIME TO REVIEW THEM BEFORE THE SHIFT CHANGE. GOOD LUCK. OVER.",
        "P.S. DON'T FORGET TO CHECK ALL CAMERA FEEDS. DON'T SCREW THIS UP.  GUESTS OR NOT WE HAVE A JOB TO DO.",
        "[BEGIN LOG: December 8th, 2008]",
        "[TIMECODE: 08:03.] DISTURBANCE. MINOR SCUFFLING BETWEEN GUESTS CHECKING OUT. STAFF DISPATCHED.",
        "[TIMECODE: 08:14.] ALL CLEAR.",
        "[TIMECODE: 10:21.] DISTURBANCE. GUEST COMPLAINT REGARDING SERVICE. NO SECURITY ACTION REQUIRED. ALL CLEAR.",
        "[TIMECODE: 13:01.]  LUNCH BREAK. MAC TAKING OVER FOR ME.",
        "[TIMECODE: 13:29]  RETURN. NO MAJOR DISTURBANCES REPORTED. RESUMING OBSERVATIONS.",
        "[TIMECODE:14:57] DISTURBANCE.  MULTIPLE GUEST RESERVATIONS NOT FOUND. LARGE AMOUNT OF GUESTS WAITING TO CHECK IN WERE VISIBLY UPSET.  STAFF DISPATCHED.",
        "[TIMECODE:15:24]. ALL CLEAR.",
        "[TIMECODE:17:42] DISTURBANCE. GUEST SLIPPED ON WET FLOOR. NO SECURITY ACTION REQUIRED. ALL CLEAR.",
        "[TIMECODE: 19:23] LAST SCHEDULED GUEST CHECKED IN. LOCKDOWN PROCEDURES INITIATED.",
        "[TIMECODE: 22:15.] DISTURBANCE. MASS POWER OUTAGE. STAFF DISPATCHED.",
      ];
      const cctv = await setUpCCTV(canvas,"images/lobby.PNG")
      const button = document.createElement("button");
      button.innerHTML = "LOBBY";
      button.onclick= ()=>{play(0)};
      buttonBar.append(button);
      return { lines, cctv }
    }

    const screen2 = async(canvas,buttonBar) => {
      const lines = [
        "[TIMECODE: 07:00.][AUTOMATED GUEST HOURLY COUNT]: 1 ",
        "[TIMECODE: 08:00.][AUTOMATED GUEST HOURLY COUNT]: 2 ",
        "[TIMECODE: 08:00.][AUTOMATED GUEST HOURLY COUNT]: 1",
        "[TIMECODE: 09:00.][AUTOMATED GUEST HOURLY COUNT]: 13",
        "[TIMECODE: 10:00.][AUTOMATED GUEST HOURLY COUNT]: 85",
        "[TIMECODE: 11:00.][AUTOMATED GUEST HOURLY COUNT]: 1",
        "[TIMECODE: 12:00.][AUTOMATED GUEST HOURLY COUNT]: 0",
        "[TIMECODE: 13:00.][AUTOMATED GUEST HOURLY COUNT]: 0",
        "[TIMECODE: 14:00.][AUTOMATED GUEST HOURLY COUNT]: 5",
        "[TIMECODE: 15:00.][AUTOMATED GUEST HOURLY COUNT]: 57",
        "[TIMECODE: 16:00.][AUTOMATED GUEST HOURLY COUNT]: 10",
        "[TIMECODE: 17:00.][AUTOMATED GUEST HOURLY COUNT]: 2",
        "[TIMECODE: 18:00.][AUTOMATED GUEST HOURLY COUNT]: 11",
        "[TIMECODE: 19:00.][AUTOMATED GUEST HOURLY COUNT]: 0",
        "[TIMECODE: 20:00.][AUTOMATED GUEST HOURLY COUNT]: 0",
        "[TIMECODE: 21:00.][AUTOMATED GUEST HOURLY COUNT]: 0",
        "[TIMECODE: 22:00.][AUTOMATED GUEST HOURLY COUNT]: 113",
        "[TIMECODE: 23:00.][AUTOMATED GUEST HOURLY COUNT]: 0",
        "[SYSTEM SHUTOFF]",
      ];
      const cctv = await setUpCCTV(canvas,"images/entrance.jpg")
      const button = document.createElement("button");
      button.innerHTML = "ENTRANCE";
      button.onclick= ()=>{play(1)};
      buttonBar.append(button);
      return { lines, cctv }
    }


    const transcript = async (lines) => {
      typing = true;
      const terminal = document.querySelector("#log-terminal");
      terminal.innerHTML = "";
      for (let line of lines) {
        if(!typing){
          break;
        }
        const element = document.createElement("p");
        terminal.append(element);
        await typeWrite(terminal, element, line)
        await sleep(speed * 10);

      }
    }

    const setUpCCTV = async (canvas, src) => {
      try{
      console.log("JR NOTE: trying to set up cctv", canvas, src)
      const frames = [];
      const image = await addImageProcess(src);
      console.log("JR NOTE: image is", image)
      frames.push(new AnimationFrame(image, 1));
      const feed = new CameraFeed(0, frames);
      const cctv = new CCTV(feed, canvas);
      cctv.setReadyToPlay(true);
      return cctv;
      }catch(e){
        console.error("ERROR SETTING UP CCTV FEED!")
        return null;
      }
    }

    const typeWrite = async (scroll_element, element, text) => {
      typing = true;
      let skipping = false;
      for (let i = 0; i < text.length; i++) {
        if(text.charAt(i) === "["){
          skipping = true;
        }else if(text.charAt(i)==="]"){
          skipping = false;
        }
        if(!skipping){
          await sleep(speed);
          clickAudio.play();
        }
        element.innerHTML += text.charAt(i);
        scroll_element.scrollTop = scroll_element.scrollHeight;
        if(!typing){
          break;
        }
      }
    }

    const play = (camera_index) => {
      console.log("JR NOTE: attempting to play", camera_index);
      typing = false;
      transcript(cameras[camera_index].lines);
      if(current_cctv){
        current_cctv.stop();
      }
      current_cctv = cameras[camera_index].cctv;
      current_cctv.play();
    }


    window.onload = () => {
      setupScreens();
      window.onclick = () => {
        clickAudio.play();
      }

      window.onmousedown = () => {
        speed = 0;
      }
      window.onmouseup = () => {
        speed = 50;
      }
    }
  </script>


</head>

<body>
  <div id="dock">
    <div id="tv">
      <div class="terminal" id="tv-terminal">
        <canvas id="canvas" width="500" height="500" />
      </div>
    </div>

    <div id="crt">
      <div class="scanline"></div>
      <div class="lines"></div>

      <div class="terminal" id="log-terminal">
        <button id="log-button" onClick="play(0)">Loading...</button>
        (CLICK AND HOLD TO SPEED UP)
      </div>
    </div>
    <div id = "button-bar"></div>
  </div>

</body>

</html>